// মডিউল লোডার - Module Loader (মডিউল লোডিং এবং ক্যাশিং)
// ফাইল I/O এবং মডিউল ক্যাশিং পরিচালনা করে

অন্তর্ভুক্ত "modules/লেক্সার";
অন্তর্ভুক্ত "modules/পার্সার";
অন্তর্ভুক্ত "modules/কম্পাইলার";

// মডিউল ক্যাশ (লোড করা মডিউল সংরক্ষণ করতে)
ধরি মডিউল_ক্যাশ = {};

// নতুন_মডিউল_লোডার - নতুন মডিউল লোডার তৈরি করো
ধরি নতুন_মডিউল_লোডার = ফাংশন() {
    ফেরত {
        "ক্যাশ": {},
        "লোড_স্ট্যাক": []  // circular import detect করার জন্য
    };
};

// মডিউল_লোড - মডিউল লোড করো
ধরি মডিউল_লোড = ফাংশন(লোডার, পথ) {
    // ক্যাশ চেক করো
    যদি (চাবি_আছে(লোডার["ক্যাশ"], পথ)) {
        ফেরত {
            "সফল": সত্য,
            "মডিউল": লোডার["ক্যাশ"][পথ],
            "লোডার": লোডার,
            "ত্রুটি": ""
        };
    }
    
    // চক্রাকার আমদানি পরীক্ষা করো
    যদি (স্ট্যাকে_আছে(লোডার["লোড_স্ট্যাক"], পথ)) {
        ফেরত {
            "সফল": মিথ্যা,
            "মডিউল": নাল,
            "লোডার": লোডার,
            "ত্রুটি": "চক্রাকার আমদানি পাওয়া গেছে: " + পথ
        };
    }
    
    // লোড স্ট্যাকে যোগ করো
    লোডার["লোড_স্ট্যাক"] = যোগ(লোডার["লোড_স্ট্যাক"], পথ);
    
    // ফাইল পড়ো (এটি Go দ্বারা বাস্তবায়িত হবে)
    ধরি ফাইল_ফলাফল = ফাইল_পড়ো(পথ);
    যদি (!ফাইল_ফলাফল["সফল"]) {
        ফেরত {
            "সফল": মিথ্যা,
            "মডিউল": নাল,
            "লোডার": লোডার,
            "ত্রুটি": "ফাইল পড়তে ব্যর্থ: " + পথ
        };
    }
    
    ধরি সোর্স_কোড = ফাইল_ফলাফল["বিষয়বস্তু"];
    
    // লেক্স, পার্স এবং কম্পাইল করো
    ধরি মডিউল_ফলাফল = মডিউল_কম্পাইল(সোর্স_কোড, পথ);
    যদি (!মডিউল_ফলাফল["সফল"]) {
        ফেরত {
            "সফল": মিথ্যা,
            "মডিউল": নাল,
            "লোডার": লোডার,
            "ত্রুটি": মডিউল_ফলাফল["ত্রুটি"]
        };
    }
    
    // ক্যাশে সংরক্ষণ করো
    লোডার["ক্যাশ"][পথ] = মডিউল_ফলাফল["মডিউল"];
    
    // লোড স্ট্যাক থেকে সরাও
    লোডার["লোড_স্ট্যাক"] = স্ট্যাক_পপ(লোডার["লোড_স্ট্যাক"]);
    
    ফেরত {
        "সফল": সত্য,
        "মডিউল": মডিউল_ফলাফল["মডিউল"],
        "লোডার": লোডার,
        "ত্রুটি": ""
    };
};

// মডিউল_কম্পাইল - মডিউল সোর্স কম্পাইল করো
ধরি মডিউল_কম্পাইল = ফাংশন(সোর্স_কোড, পথ) {
    // লেক্স করো
    ধরি লেক্সার = নতুন_লেক্সার(সোর্স_কোড);
    
    // পার্স করো
    ধরি পার্সার = নতুন_পার্সার(লেক্সার);
    ধরি পার্স_ফলাফল = পার্স_প্রোগ্রাম(পার্সার);
    পার্সার = পার্স_ফলাফল["পার্সার"];
    ধরি প্রোগ্রাম = পার্স_ফলাফল["প্রোগ্রাম"];
    
    // পার্সার ত্রুটি চেক করো
    যদি (দৈর্ঘ্য(পার্সার["ত্রুটি"]) > ০) {
        ধরি ত্রুটি_বার্তা = "পার্সিং ত্রুটি " + পথ + " তে:\n";
        পর্যন্ত (ধরি i = ০; i < দৈর্ঘ্য(পার্সার["ত্রুটি"]); i = i + ১) {
            ত্রুটি_বার্তা = ত্রুটি_বার্তা + পার্সার["ত্রুটি"][i] + "\n";
        }
        ফেরত {"সফল": মিথ্যা, "মডিউল": নাল, "ত্রুটি": ত্রুটি_বার্তা};
    }
    
    // কম্পাইল করো
    ধরি কম্পাইলার = নতুন_কম্পাইলার();
    ধরি কম্পাইল_ফলাফল = কম্পাইল(কম্পাইলার, প্রোগ্রাম);
    
    যদি (!কম্পাইল_ফলাফল["সফল"]) {
        ফেরত {
            "সফল": মিথ্যা,
            "মডিউল": নাল,
            "ত্রুটি": "কম্পাইল ত্রুটি " + পথ + " তে: " + কম্পাইল_ফলাফল["ত্রুটি"]
        };
    }
    
    কম্পাইলার = কম্পাইল_ফলাফল["কম্পাইলার"];
    
    // বাইটকোড পাও
    ধরি বাইটকোড = বাইটকোড_পাও(কম্পাইলার);
    
    // মডিউল তৈরি করো
    ধরি মডিউল = {
        "পথ": পথ,
        "বাইটকোড": বাইটকোড,
        "এক্সপোর্ট": {}  // মডিউল দ্বারা exported মান
    };
    
    ফেরত {"সফল": সত্য, "মডিউল": মডিউল, "ত্রুটি": ""};
};

// পথ_স্বাভাবিক_করো - মডিউল পথ স্বাভাবিক করো
ধরি পথ_স্বাভাবিক_করো = ফাংশন(পথ, বর্তমান_ডিরেক্টরি) {
    // আপেক্ষিক পথ পরিচালনা করো
    যদি (পথ_শুরু_হয়(পথ, "./")) {
        ফেরত বর্তমান_ডিরেক্টরি + "/" + পথ_স্লাইস(পথ, ২, দৈর্ঘ্য(পথ));
    } নাহলে যদি (পথ_শুরু_হয়(পথ, "../")) {
        // এক লেভেল উপরে যাও
        ধরি প্যারেন্ট = ডিরেক্টরি_প্যারেন্ট(বর্তমান_ডিরেক্টরি);
        ফেরত প্যারেন্ট + "/" + পথ_স্লাইস(পথ, ৩, দৈর্ঘ্য(পথ));
    }
    
    // পরম পথ বা modules/ দিয়ে শুরু
    ফেরত পথ;
};

// এক্সটেনশন_যোগ - .ভাষা এক্সটেনশন যোগ করো যদি না থাকে
ধরি এক্সটেনশন_যোগ = ফাংশন(পথ) {
    যদি (!পথ_শেষ_হয়(পথ, ".ভাষা")) {
        ফেরত পথ + ".ভাষা";
    }
    ফেরত পথ;
};

// মডিউল_ক্যাশ_সাফ - মডিউল ক্যাশ সাফ করো
ধরি মডিউল_ক্যাশ_সাফ = ফাংশন(লোডার) {
    লোডার["ক্যাশ"] = {};
    ফেরত লোডার;
};

// মডিউল_ক্যাশে_আছে - ক্যাশে মডিউল আছে কি না পরীক্ষা করো
ধরি মডিউল_ক্যাশে_আছে = ফাংশন(লোডার, পথ) {
    ফেরত চাবি_আছে(লোডার["ক্যাশ"], পথ);
};

// =============== Helper ফাংশন ===============

// ফাইল_পড়ো - ফাইল পড়ো (Go দ্বারা বাস্তবায়িত হবে)
ধরি ফাইল_পড়ো = ফাংশন(পথ) {
    // এটি একটি placeholder - Go VM দ্বারা বাস্তবায়িত হবে
    // বাস্তব বাস্তবায়নে, এটি Go-র os.ReadFile ব্যবহার করবে
    
    লেখ("ফাইল পড়া হচ্ছে: " + পথ);
    
    // সিমুলেটেড ফলাফল
    ফেরত {
        "সফল": সত্য,
        "বিষয়বস্তু": "// খালি মডিউল",
        "ত্রুটি": ""
    };
};

// স্ট্যাকে_আছে - স্ট্যাকে উপাদান আছে কি না
ধরি স্ট্যাকে_আছে = ফাংশন(স্ট্যাক, উপাদান) {
    পর্যন্ত (ধরি i = ০; i < দৈর্ঘ্য(স্ট্যাক); i = i + ১) {
        যদি (স্ট্যাক[i] == উপাদান) {
            ফেরত সত্য;
        }
    }
    ফেরত মিথ্যা;
};

// স্ট্যাক_পপ - স্ট্যাক থেকে শেষ উপাদান সরাও
ধরি স্ট্যাক_পপ = ফাংশন(স্ট্যাক) {
    যদি (দৈর্ঘ্য(স্ট্যাক) == ০) {
        ফেরত স্ট্যাক;
    }
    ফেরত অ্যারে_স্লাইস(স্ট্যাক, ০, দৈর্ঘ্য(স্ট্যাক) - ১);
};

// পথ_শুরু_হয় - পথ নির্দিষ্ট prefix দিয়ে শুরু হয় কি না
ধরি পথ_শুরু_হয় = ফাংশন(পথ, prefix) {
    যদি (দৈর্ঘ্য(পথ) < দৈর্ঘ্য(prefix)) {
        ফেরত মিথ্যা;
    }
    
    পর্যন্ত (ধরি i = ০; i < দৈর্ঘ্য(prefix); i = i + ১) {
        যদি (পথ[i] != prefix[i]) {
            ফেরত মিথ্যা;
        }
    }
    
    ফেরত সত্য;
};

// পথ_শেষ_হয় - পথ নির্দিষ্ট suffix দিয়ে শেষ হয় কি না
ধরি পথ_শেষ_হয় = ফাংশন(পথ, suffix) {
    ধরি পথ_দৈর্ঘ্য = দৈর্ঘ্য(পথ);
    ধরি suffix_দৈর্ঘ্য = দৈর্ঘ্য(suffix);
    
    যদি (পথ_দৈর্ঘ্য < suffix_দৈর্ঘ্য) {
        ফেরত মিথ্যা;
    }
    
    ধরি শুরু = পথ_দৈর্ঘ্য - suffix_দৈর্ঘ্য;
    পর্যন্ত (ধরি i = ০; i < suffix_দৈর্ঘ্য; i = i + ১) {
        যদি (পথ[শুরু + i] != suffix[i]) {
            ফেরত মিথ্যা;
        }
    }
    
    ফেরত সত্য;
};

// পথ_স্লাইস - পথের অংশ নাও
ধরি পথ_স্লাইস = ফাংশন(পথ, শুরু, শেষ) {
    ধরি ফলাফল = "";
    পর্যন্ত (ধরি i = শুরু; i < শেষ; i = i + ১) {
        ফলাফল = ফলাফল + পথ[i];
    }
    ফেরত ফলাফল;
};

// ডিরেক্টরি_প্যারেন্ট - ডিরেক্টরির প্যারেন্ট পাও
ধরি ডিরেক্টরি_প্যারেন্ট = ফাংশন(পথ) {
    // সর্বশেষ / খুঁজো
    ধরি শেষ_স্ল্যাশ = -১;
    পর্যন্ত (ধরি i = দৈর্ঘ্য(পথ) - ১; i >= ০; i = i - ১) {
        যদি (পথ[i] == "/") {
            শেষ_স্ল্যাশ = i;
            বিরতি;
        }
    }
    
    যদি (শেষ_স্ল্যাশ == -১) {
        ফেরত ".";
    }
    
    ফেরত পথ_স্লাইস(পথ, ০, শেষ_স্ল্যাশ);
};

লেখ("মডিউল লোডার মডিউল লোড হয়েছে");

